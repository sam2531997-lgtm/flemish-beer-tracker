<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Flemish Tracker</title>

<link rel="manifest" href="manifest.json">

<style>

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,Segoe UI;
background:#f7f9fc;
color:#1c1c1c;
}

h1{
text-align:center;
margin:24px 0 10px;
font-weight:700;
}

.container{
max-width:760px;
margin:auto;
padding:10px;
}

.card{
background:white;
border-radius:16px;
padding:20px;
margin:18px 0;
box-shadow:0 8px 24px rgba(0,0,0,.06);
}

input{
width:100%;
padding:12px;
border-radius:10px;
border:1px solid #ddd;
margin-top:6px;
}

button{
width:100%;
padding:16px;
border:none;
border-radius:12px;
background:#4CAF50;
color:white;
font-size:16px;
font-weight:600;
margin-top:14px;
cursor:pointer;
transition:.2s;
}

button:hover{
transform:scale(1.02);
}

.stats{
display:flex;
justify-content:space-between;
margin-top:14px;
font-weight:600;
}

.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:6px;
margin-top:16px;
}

.day{
padding:12px 0;
border-radius:8px;
font-size:13px;
text-align:center;
background:#eef1f5;
}

.done{background:#66bb6a;color:white;}
.missed{background:#ef5350;color:white;}
.today{outline:3px solid orange;}
.future{opacity:.35}

.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:8px;
}

.streak{
font-size:14px;
opacity:.7;
}

</style>
</head>

<body>

<h1>üáßüá™ Flemish Tracker</h1>

<div class="container">

<div class="card">
Room
<input id="roomInput" value="samuel-joel">
<button onclick="connect()">Connect</button>
<div id="status"></div>
</div>

<div id="samuel"></div>
<div id="joel"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>

firebase.initializeApp({
apiKey:"AIzaSyCCnKfM04RXZxP57j7MjhDjK-4wM8oAjFQ",
authDomain:"flemish-beer-tracker.firebaseapp.com",
projectId:"flemish-beer-tracker"
});

const db=firebase.firestore();
const auth=firebase.auth();

let room;
let unsub;

const today=()=>new Date().toISOString().slice(0,10);

async function connect(){

await auth.signInAnonymously();

room=document.getElementById("roomInput").value;

const ref=db.collection("rooms").doc(room);

await ref.set({init:true},{merge:true});

if(unsub)unsub();

unsub=ref.onSnapshot(async snap=>{
let data=snap.data()?.entries||{};
await autoMiss(ref,data);
render(data);
});

document.getElementById("status").innerText="Connected ‚úÖ";
}

async function autoMiss(ref,entries){

const y=new Date();
y.setDate(y.getDate()-1);
const yd=y.toISOString().slice(0,10);

if(entries[yd]) return;

await ref.set({
entries:{
[yd]:{
samuel:false,
joel:false
}
}
},{merge:true});
}

async function done(person){

const ref=db.collection("rooms").doc(room);
await ref.set({
entries:{
[today()]:{
[person]:true
}
}
},{merge:true});
}

function streak(entries,p){

let days=0;
let d=new Date();

while(true){
let k=d.toISOString().slice(0,10);
if(entries[k]?.[p]) days++;
else break;
d.setDate(d.getDate()-1);
}

return days;
}

function beers(entries,p){
return Object.values(entries)
.filter(e=>e[p]===false).length;
}

function calendar(entries,p){

const now=new Date();
const y=now.getFullYear();
const m=now.getMonth();
const last=new Date(y,m+1,0).getDate();

let html='<div class="calendar">';

for(let i=1;i<=last;i++){

let d=new Date(y,m,i).toISOString().slice(0,10);
let c="day";

if(d>today())c+=" future";
else if(entries[d]?.[p]===true)c+=" done";
else if(entries[d]?.[p]===false)c+=" missed";

if(d===today())c+=" today";

html+=`<div class="${c}">${i}</div>`;
}

html+="</div>";

return html;
}

function panel(id,name,entries){

return `
<div class="card">

<div class="header">
<h2>${name}</h2>
<div class="streak">üî• ${streak(entries,id)} day streak</div>
</div>

<button onclick="done('${id}')">
‚úÖ I DID FLEMISH TODAY
</button>

<div class="stats">
<div>üç∫ Beers owed: ${beers(entries,id)}</div>
</div>

${calendar(entries,id)}

</div>`;
}

function render(entries){

document.getElementById("samuel")
.innerHTML=panel("samuel","Samuel",entries);

document.getElementById("joel")
.innerHTML=panel("joel","Joel",entries);

}

</script>

</body>
</html>
