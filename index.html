<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Flemish Tracker</title>

<style>

body{
font-family:-apple-system,BlinkMacSystemFont,Segoe UI;
background:#f4f6f8;
margin:0;
color:#1f2933;
}

.wrap{
max-width:1100px;
margin:auto;
padding:30px 20px;
}

h1{
margin-bottom:20px;
}

.card{
background:white;
border-radius:14px;
padding:20px;
margin-bottom:20px;
box-shadow:0 2px 8px rgba(0,0,0,.06);
}

.row{
display:flex;
gap:20px;
flex-wrap:wrap;
}

.player{
flex:1;
min-width:420px;
}

button{
border:none;
padding:14px;
border-radius:10px;
font-weight:600;
cursor:pointer;
}

.done{
background:#4CAF50;
color:white;
width:100%;
font-size:16px;
}

.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:6px;
margin-top:10px;
}

.day{
padding:10px;
text-align:center;
border-radius:8px;
background:#e5e7eb;
font-size:14px;
}

.doneDay{background:#86efac;}
.missedDay{background:#fca5a5;}
.today{
outline:3px solid #f59e0b;
}

.score{
font-size:20px;
font-weight:700;
text-align:center;
}

.hidden{display:none;}

</style>
</head>

<body>

<div class="wrap">

<h1>Flemish Tracker</h1>

<div id="connectCard" class="card">
<input id="roomInput" placeholder="Room code"/>
<button onclick="connect()">Connect</button>
</div>

<div id="app" class="hidden">

<div class="card score" id="debtDisplay"></div>

<div class="row">

<div class="card player">
<h2>Samuel üîµ</h2>
<button class="done" onclick="markDone('samuel')">
‚úÖ I DID FLEMISH TODAY
</button>
<div id="samuelCalendar" class="calendar"></div>
</div>

<div class="card player">
<h2>Joel üü†</h2>
<button class="done" onclick="markDone('joel')">
‚úÖ I DID FLEMISH TODAY
</button>
<div id="joelCalendar" class="calendar"></div>
</div>

</div>

</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>

const firebaseConfig={
apiKey:"AIzaSyCCnKfM04RXZxP57j7MjhDjK-4wM8oAjFQ",
authDomain:"flemish-beer-tracker.firebaseapp.com",
projectId:"flemish-beer-tracker"
};

firebase.initializeApp(firebaseConfig);

const db=firebase.firestore();
const auth=firebase.auth();

let room=null;
let state={entries:{},settled:{}};

function iso(d){
return new Date(d).toISOString().slice(0,10);
}

function yesterday(){
let d=new Date();
d.setDate(d.getDate()-1);
return iso(d);
}

async function connect(){

await auth.signInAnonymously();

room=document.getElementById("roomInput").value
.toLowerCase().trim();

db.collection("rooms").doc(room)
.onSnapshot(async snap=>{

state=snap.data()||{entries:{},settled:{}};

await runSettlement();

render();

});

document.getElementById("connectCard").classList.add("hidden");
document.getElementById("app").classList.remove("hidden");
}

async function markDone(person){

let today=iso(new Date());

let entry=state.entries[today]||{};
entry[person]=true;

await db.collection("rooms")
.doc(room)
.set({
entries:{
[today]:entry
}
},{merge:true});
}

async function runSettlement(){

let y=yesterday();

if(state.settled?.[y]) return;

let e=state.entries?.[y];
if(!e) return;

let sam=e.samuel===true;
let joe=e.joel===true;

let debt=state.debt||{samuel:0,joel:0};

if(sam && !joe) debt.joel++;
if(joe && !sam) debt.samuel++;

await db.collection("rooms").doc(room).set({
debt,
settled:{[y]:true}
},{merge:true});
}

function render(){

renderPlayer("samuel");
renderPlayer("joel");

let d=state.debt||{samuel:0,joel:0};

let text="All square ‚úÖ";

if(d.samuel>d.joel)
text=`Samuel owes Joel ${d.samuel-d.joel} üç∫`;

if(d.joel>d.samuel)
text=`Joel owes Samuel ${d.joel-d.samuel} üç∫`;

document.getElementById("debtDisplay").innerText=text;
}

function renderPlayer(name){

let el=document.getElementById(name+"Calendar");
el.innerHTML="";

let now=new Date();
let year=now.getFullYear();
let month=now.getMonth();

let days=new Date(year,month+1,0).getDate();

for(let i=1;i<=days;i++){

let d=new Date(year,month,i);
let key=iso(d);

let div=document.createElement("div");
div.className="day";
div.innerText=i;

let entry=state.entries?.[key];

if(entry?.[name]) div.classList.add("doneDay");
else if(key<iso(new Date()))
div.classList.add("missedDay");

if(key===iso(new Date()))
div.classList.add("today");

el.appendChild(div);
}
}

</script>

</body>
</html>
