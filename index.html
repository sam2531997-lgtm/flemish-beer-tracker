<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Flemish Beer Pact</title>

<style>
body{
margin:0;
background:#0B0F1A;
color:white;
font-family:system-ui;
padding:20px;
}

.wrap{max-width:700px;margin:auto}

.card{
background:#141A2B;
border-radius:14px;
padding:16px;
margin-bottom:14px;
}

h1{margin:0 0 6px}

.big{
font-size:42px;
font-weight:bold;
}

button{
padding:14px;
border-radius:12px;
border:none;
font-size:16px;
cursor:pointer;
}

.done{
background:#2EE59D;
color:black;
width:100%;
font-weight:bold;
}

.player{
display:flex;
justify-content:space-between;
font-size:18px;
margin:6px 0;
}

.good{color:#2EE59D}
.bad{color:#FF5A7A}

input{
width:100%;
padding:10px;
border-radius:10px;
border:none;
margin-top:8px;
}
</style>
</head>

<body>
<div class="wrap">

<h1>ðŸ‡§ðŸ‡ª Flemish Beer Pact</h1>

<div class="card">
Room:
<input id="roomInput" placeholder="samuel-joel">
<button onclick="connect()">Connect</button>
<div id="status"></div>
</div>

<div class="card">
<div id="today"></div>
<button class="done" onclick="markDone()">âœ… I DID FLEMISH TODAY</button>
</div>

<div class="card">
<div class="player">
<span>Samuel</span>
<span id="samuelStats"></span>
</div>

<div class="player">
<span>Joel</span>
<span id="joelStats"></span>
</div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>

const firebaseConfig={
apiKey:"AIzaSyCCnKfM04RXZxP57j7MjhDjK-4wM8oAjFQ",
authDomain:"flemish-beer-tracker.firebaseapp.com",
projectId:"flemish-beer-tracker"
};

firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

let room=null;
let me=null;

function todayISO(){
return new Date().toISOString().slice(0,10);
}

async function initAuth(){
if(!auth.currentUser)
await auth.signInAnonymously();
}

function chooseIdentity(){
if(localStorage.getItem("player")){
me=localStorage.getItem("player");
return;
}

me=prompt("Are you samuel or joel?").toLowerCase();
localStorage.setItem("player",me);
}

async function connect(){

await initAuth();
chooseIdentity();

room=document.getElementById("roomInput").value.toLowerCase();

localStorage.setItem("room",room);

db.collection("rooms").doc(room)
.onSnapshot(snap=>{
const data=snap.data()||{};
processAutoMiss(data);
render(data);
});

document.getElementById("status").innerText="Connected";
}

async function processAutoMiss(data){

const entries=data.entries||{};
const yesterday=new Date(Date.now()-86400000)
.toISOString().slice(0,10);

if(entries[yesterday]) return;

await db.collection("rooms").doc(room)
.set({
[`entries.${yesterday}`]:{
samuel:"miss",
joel:"miss"
}
},{merge:true});
}

async function markDone(){

const today=todayISO();

await db.collection("rooms").doc(room)
.set({
[`entries.${today}.${me}`]:"done"
},{merge:true});
}

function calc(entries,name){

let beers=0;
let streak=0;

const dates=Object.keys(entries).sort().reverse();

for(const d of dates){

if(entries[d][name]==="miss")
beers++;

if(entries[d][name]==="done")
streak++;
else break;
}

return {beers,streak};
}

function render(data){

const entries=data.entries||{};

document.getElementById("today")
.innerHTML=`Today: ${todayISO()}`;

const s=calc(entries,"samuel");
const j=calc(entries,"joel");

document.getElementById("samuelStats")
.innerHTML=`ðŸ”¥${s.streak} | ðŸº${s.beers}`;

document.getElementById("joelStats")
.innerHTML=`ðŸ”¥${j.streak} | ðŸº${j.beers}`;
}

window.onload=()=>{
const saved=localStorage.getItem("room");
if(saved){
document.getElementById("roomInput").value=saved;
connect();
}
}

</script>
</body>
</html>
